<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.embed.mapper.RestaurantMapper">

	<resultMap id="restaurantWithMenusMap" type="org.embed.dto.RestaurantDTO">
	
	    <id     property="id"             column="id"/>
	    <result property="name"           column="name"/>
	    <result property="category"       column="category"/>
	    <result property="regionLevel1"   column="region_level1"/>
	    <result property="regionLevel2"   column="region_level2"/>
	    <result property="regionLevel3"   column="region_level3"/>
	    <result property="address"        column="address"/>
	
	    <!-- 평점 / 리뷰 갯수 -->
	    <result property="avgRating"      column="avg_rating"/>
	    <result property="reviewCount"    column="review_count"/>
	
	    <result property="mainImageUrl"   column="main_image_url"/>
	
	    <!-- 메뉴 리스트 -->
	    <collection property="menus" ofType="org.embed.dto.MenuDTO">
	        <id     property="id"          column="menu_id"/>
	        <result property="name"        column="menu_name"/>
	        <result property="price"       column="menu_price"/>
	        <result property="description" column="menu_description"/>
	    </collection>
	</resultMap>

    <!-- ======================================
         개별 맛집 조회 (+평균점수 +리뷰수)
    ====================================== -->
    <select id="findById" parameterType="long" resultType="org.embed.dto.RestaurantDTO">
        <![CDATA[
            SELECT
                r.*,
                u.name AS owner_name,
                COALESCE(ROUND(AVG(rv.rating), 1), 0) AS avg_rating,
                COALESCE(COUNT(rv.id), 0) AS review_count
            FROM restaurant r
            LEFT JOIN user u ON r.owner_id = u.id
            LEFT JOIN review rv ON r.id = rv.restaurant_id
            WHERE r.id = #{id}
            GROUP BY r.id
        ]]>
    </select>


    <!-- ======================================
         INSERT
    ====================================== -->
    <insert id="insertRestaurant" parameterType="org.embed.dto.RestaurantDTO"
            useGeneratedKeys="true" keyProperty="id">
        <![CDATA[
            INSERT INTO restaurant (
                owner_id,
                name,
                description,
                address,
                region_level1,
                region_level2,
                region_level3,
                category,
                latitude,
                longitude,
                main_image_url
            ) VALUES (
                #{ownerId},
                #{name},
                #{description},
                #{address},
                #{regionLevel1},
                #{regionLevel2},
                #{regionLevel3},
                #{category},
                #{latitude},
                #{longitude},
                #{mainImageUrl}
            )
        ]]>
    </insert>


    <!-- ======================================
         UPDATE
    ====================================== -->
    <update id="updateRestaurant" parameterType="org.embed.dto.RestaurantDTO">
        <![CDATA[
            UPDATE restaurant
            SET
                owner_id       = #{ownerId},
                name           = #{name},
                description    = #{description},
                address        = #{address},
                region_level1  = #{regionLevel1},
                region_level2  = #{regionLevel2},
                region_level3  = #{regionLevel3},
                category       = #{category},
                latitude       = #{latitude},
                longitude      = #{longitude},
                main_image_url = #{mainImageUrl}
            WHERE id = #{id}
        ]]>
    </update>


    <!-- ======================================
         DELETE
    ====================================== -->
    <delete id="deleteRestaurant" parameterType="long">
        <![CDATA[
            DELETE FROM restaurant WHERE id = #{id}
        ]]>
    </delete>



    <!-- ======================================
         사용자용 검색/필터
    ====================================== -->
    <select id="findByFilter" parameterType="map" resultType="org.embed.dto.RestaurantDTO">
        <![CDATA[
            SELECT 
                r.*,
                COALESCE(ROUND(AVG(rv.rating), 1), 0) AS avg_rating
            FROM restaurant r
            LEFT JOIN review rv ON r.id = rv.restaurant_id
        ]]>
        <where>

            <!-- 지역  -->
            <if test="regionLevel1 != null and regionLevel1 != ''">
                r.region_level1 = #{regionLevel1}
            </if>
            <if test="regionLevel2 != null and regionLevel2 != ''">
                AND r.region_level2 = #{regionLevel2}
            </if>
      
            <!-- 카테고리 -->
            <if test="category != null and category != ''">
                AND r.category = #{category}
            </if>

            <!-- 키워드 -->
            <if test="keyword != null and keyword != ''">
                AND r.name LIKE CONCAT('%', #{keyword}, '%')
            </if>

        </where>
        <![CDATA[
            GROUP BY r.id
            ORDER BY r.name ASC
            LIMIT #{offset}, #{limit}
        ]]>
    </select>


    <!-- 검색 결과 총 개수 -->
    <select id="countByFilter" parameterType="map" resultType="int">
        <![CDATA[
            SELECT COUNT(*)
            FROM restaurant r
        ]]>
        <where>

            <!-- 지역 3단 필터 -->
            <if test="regionLevel1 != null and regionLevel1 != ''">
                r.region_level1 = #{regionLevel1}
            </if>
            <if test="regionLevel2 != null and regionLevel2 != ''">
                AND r.region_level2 = #{regionLevel2}
            </if>


            <!-- 카테고리 -->
            <if test="category != null and category != ''">
                AND r.category = #{category}
            </if>

            <!-- 키워드 -->
            <if test="keyword != null and keyword != ''">
                AND r.name LIKE CONCAT('%', #{keyword}, '%')
            </if>

        </where>
    </select>



    <!-- ======================================
         관리자용 리스트 + 필터 + 페이지네이션
    ====================================== -->
    <select id="findAll" parameterType="map" resultType="org.embed.dto.RestaurantDTO">
        <![CDATA[
            SELECT 
                r.*,
                u.name AS owner_name,
                COALESCE(ROUND(AVG(rv.rating), 1), 0) AS avg_rating
            FROM restaurant r
            LEFT JOIN user u ON r.owner_id = u.id
            LEFT JOIN review rv ON r.id = rv.restaurant_id
        ]]>
        <where>

            <if test="keyword != null and keyword != ''">
                r.name LIKE CONCAT('%', #{keyword}, '%')
            </if>

            <if test="ownerFilter != null and ownerFilter == 'HAS'">
                AND r.owner_id IS NOT NULL
            </if>

            <if test="ownerFilter != null and ownerFilter == 'NONE'">
                AND r.owner_id IS NULL
            </if>

        </where>
        <![CDATA[
            GROUP BY r.id
            ORDER BY r.created_at DESC
            LIMIT #{offset}, #{limit}
        ]]>
    </select>


    <select id="countAllWithOwner" parameterType="map" resultType="int">
        <![CDATA[
            SELECT COUNT(*)
            FROM restaurant r
        ]]>
        <where>

            <if test="keyword != null and keyword != ''">
                r.name LIKE CONCAT('%', #{keyword}, '%')
            </if>

            <if test="ownerFilter != null and ownerFilter == 'HAS'">
                AND r.owner_id IS NOT NULL
            </if>

            <if test="ownerFilter != null and ownerFilter == 'NONE'">
                AND r.owner_id IS NULL
            </if>

        </where>
    </select>


    <!-- 오너 지정 -->
    <update id="updateOwner" parameterType="map">
        <![CDATA[
            UPDATE restaurant
            SET owner_id = #{ownerId}
            WHERE id = #{restaurantId}
        ]]>
    </update>


    <!-- 오너가 있는 restaurant owner_id 목록 -->
    <select id="findAssignedOwnerIds" resultType="long">
        <![CDATA[
            SELECT DISTINCT owner_id
            FROM restaurant
            WHERE owner_id IS NOT NULL
        ]]>
    </select>
    
    <select id="findAllForAI" resultMap="restaurantWithMenusMap">
	    <![CDATA[
	        SELECT
		        r.id,
		        r.name,
		        r.category,
		        r.region_level1,
		        r.region_level2,
		        r.region_level3,
		        r.address,
		        IFNULL(rv.avg_rating, 0) AS avg_rating,
		        IFNULL(rv.review_count, 0) AS review_count,
		        r.main_image_url,
		
		        m.id AS menu_id,
		        m.name AS menu_name,
		        m.price AS menu_price,
		        m.description AS menu_description
		
		    FROM restaurant r
		
		    LEFT JOIN (
		        SELECT restaurant_id,
		               AVG(rating) AS avg_rating,
		               COUNT(id) AS review_count
		        FROM review
		        GROUP BY restaurant_id
		    ) rv ON r.id = rv.restaurant_id
		
		    LEFT JOIN menu m ON r.id = m.restaurant_id
		
		    ORDER BY r.id ASC
	    ]]>
	</select>


</mapper>
