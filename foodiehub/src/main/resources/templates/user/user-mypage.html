<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>마이페이지 | FoodieHub</title>
    <link rel="stylesheet" th:href="@{/css/modal.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

    <div th:replace="layout/header :: header"></div>

    <!-- 페이지 헤더 -->
    <div class="page-header">
        <button type="button" class="btn-back-nav" onclick="history.back()">← 뒤로가기</button>
        <h1>마이페이지</h1>
    </div>

    <!-- 마이페이지 메인 -->
    <main class="page-main mypage-main">
        <div class="mypage-container">

            <!-- 왼쪽: 프로필 -->
            <section class="mypage-left">
                <div class="mypage-profile">
                    <img th:src="${user.profileImageUrl != null ? user.profileImageUrl : '/images/default-profile.png'}"
                         alt="프로필 이미지" class="mypage-profile-img">
                    <h3 th:text="${user.name}"></h3>
                </div>

                <!-- SNS 로그인 배지 -->
                <div th:if="${user.provider != null}" class="account-badge" 
                     th:classappend="${user.provider == 'kakao' ? 'badge-kakao' : 'badge-naver'}">
                    <img th:if="${user.provider == 'kakao'}" 
                         th:src="@{/images/kakao-logo.png}" 
                         alt="카카오" class="badge-logo">
                    <img th:if="${user.provider == 'naver'}" 
                         th:src="@{/images/naver-logo.png}" 
                         alt="네이버" class="badge-logo">
                    <span th:text="${user.provider == 'kakao' ? '카카오' : '네이버'}"></span> 계정
                </div>

                <div class="mypage-info">
                    <p><strong>이메일:</strong> <span th:text="${user.email}"></span></p>
                    <p><strong>전화번호:</strong> <span th:text="${user.phone}"></span></p>
                    <p><strong>주소:</strong> <span th:text="${user.address}"></span></p>
                    <p><strong>생년월일:</strong>
                        <span th:text="${#temporals.format(user.birthDate, 'yyyy-MM-dd')}"></span></p>
                    <p><strong>성별:</strong>
                        <span th:text="${user.gender == 'M' ? '남성' : (user.gender == 'F' ? '여성' : '기타')}"></span>
                    </p>
                </div>

                <div class="mypage-actions">
                    <a href="/user/edit" class="edit-btn">정보 수정</a>
                    <form th:action="@{/user/delete}" method="post" onsubmit="return confirm('정말 탈퇴하시겠습니까?');">
                        <button type="submit" class="delete-btn">회원 탈퇴</button>
                    </form>
                </div>
            </section>

            <!-- 오른쪽: 탭 -->
            <section class="mypage-right">
                <div class="tab-menu">
                    <button class="tab-btn" data-tab="reviews">내가 쓴 리뷰</button>
                    <button class="tab-btn" data-tab="boards">내가 쓴 게시글</button>
                </div>

                <!-- 리뷰 탭 -->
				<div id="reviews" class="tab-content">
				    <div class="tab-content-header">
				        <h3>내가 쓴 리뷰</h3>
				        <p class="review-count"
				           th:text="'총 ' + (${totalReviews != null} ? ${totalReviews} : 0) + '개의 리뷰를 작성했습니다.'"></p>
				    </div>
				
				    <div th:if="${#lists.isEmpty(reviews)}" class="empty-box">
				        <p>작성한 리뷰가 없습니다.</p>
				    </div>
				
				    <div class="scroll-list">
					    <div th:each="r : ${reviews}" class="item-card">
					        <p class="item-title">
					            <a th:href="@{'/restaurant/detail/' + ${r.restaurantId} + '#reviews'}"
					               th:text="${r.restaurantName}"></a>
					        </p>
					        <p class="item-content" th:text="${r.content}"></p>
					        <small th:text="${#temporals.format(r.createdAt, 'yyyy-MM-dd HH:mm')}"></small>
					        
					        <!-- 수정/삭제 버튼 -->
					        <div class="review-actions">
					            <button type="button" class="btn-edit" 
					                    th:data-review-id="${r.id}" 
					                    th:data-rating="${r.rating}" 
					                    th:data-content="${r.content}">수정</button>
					            <form method="post" th:action="@{/review/delete}" style="display:inline;">
					                <input type="hidden" name="id" th:value="${r.id}">
					                <button type="submit" class="btn-delete" 
					                        onclick="return confirm('정말 삭제하시겠습니까?');">삭제</button>
					            </form>
					        </div>
					    </div>
					</div>
				
				    <div class="pagination" th:if="${reviewTotalPages > 1}">
				        <a th:if="${reviewCurrentPage > 1}"
				           th:href="@{/user/mypage(reviewPage=${reviewCurrentPage - 1}, boardPage=${boardCurrentPage})}">이전</a>
				        <span th:text="${reviewCurrentPage} + ' / ' + ${reviewTotalPages}"></span>
				        <a th:if="${reviewCurrentPage < reviewTotalPages}"
				           th:href="@{/user/mypage(reviewPage=${reviewCurrentPage + 1}, boardPage=${boardCurrentPage})}">다음</a>
				    </div>
				</div>
				
				<!-- 게시글 탭 -->
				<div id="boards" class="tab-content">
				    <div class="tab-content-header">
				        <h3>내가 쓴 게시글</h3>
				        <p class="review-count"
				           th:text="'총 ' + (${totalBoards != null} ? ${totalBoards} : 0) + '개의 게시글을 작성했습니다.'"></p>
				    </div>
				
				    <div th:if="${#lists.isEmpty(boards)}" class="empty-box">
				        <p>작성한 게시글이 없습니다.</p>
				    </div>
				
				    <div class="scroll-list">
				        <a th:each="b : ${boards}"
				           th:href="@{'/board/detail/' + ${b.id}}"
				           class="item-card">
				            <p class="item-title" th:text="${b.title}"></p>
				            <p class="item-content" th:text="${b.content}"></p>
				            <small th:text="${#temporals.format(b.createdAt, 'yyyy-MM-dd HH:mm')}"></small>
				        </a>
				    </div>
				
				    <div class="pagination" th:if="${boardTotalPages > 1}">
				        <a th:if="${boardCurrentPage > 1}"
				           th:href="@{/user/mypage(reviewPage=${reviewCurrentPage}, boardPage=${boardCurrentPage - 1})}">이전</a>
				        <span th:text="${boardCurrentPage} + ' / ' + ${boardTotalPages}"></span>
				        <a th:if="${boardCurrentPage < boardTotalPages}"
				           th:href="@{/user/mypage(reviewPage=${reviewCurrentPage}, boardPage=${boardCurrentPage + 1})}">다음</a>
				    </div>
				</div>
            </section>
        </div>
    </main>

    <!-- 수정 모달 (공통 클래스 사용) -->
    <div id="editReviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>리뷰 수정</h3>
                <button type="button" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form method="post" action="/review/update">
                    <input type="hidden" id="editReviewId" name="id">
                    
                    <div class="form-group">
                        <label class="form-label">별점</label>
                        <select id="editRating" name="rating" class="form-control" required>
                            <option value="5">★★★★★</option>
                            <option value="4">★★★★☆</option>
                            <option value="3">★★★☆☆</option>
                            <option value="2">★★☆☆☆</option>
                            <option value="1">★☆☆☆☆</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">리뷰 내용</label>
                        <textarea id="editContent" name="content" class="form-control form-textarea" required></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-submit">수정 완료</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div th:replace="layout/footer :: footer"></div>

    <script>
        // 스크롤 복원 방지
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }

        // 페이지 로드 시 스크롤 상단 고정
        window.addEventListener("load", () => {
            requestAnimationFrame(() => {
                window.scrollTo({ top: 0, left: 0, behavior: "auto" });
            });
        });

        // DOM 로드 완료 후 실행
        document.addEventListener("DOMContentLoaded", function() {
            
            /* ============================================
               탭 전환 기능
            ============================================ */
            const tabBtns = document.querySelectorAll(".tab-btn");
            const tabContents = document.querySelectorAll(".tab-content");

            function activateTab(tabId) {
                tabBtns.forEach(btn => btn.classList.toggle("active", btn.dataset.tab === tabId));
                tabContents.forEach(content => content.classList.toggle("active", content.id === tabId));
                history.replaceState(null, "", "#" + tabId);
                window.scrollTo({ top: 0, behavior: "smooth" });
            }

            // 탭 버튼 클릭 이벤트
            tabBtns.forEach(btn => {
                btn.addEventListener("click", () => activateTab(btn.dataset.tab));
            });

            // 초기 탭 활성화
            const currentHash = window.location.hash.replace("#", "");
            activateTab(currentHash || "reviews");

            // 페이지네이션 클릭 시 상단 이동
            document.querySelectorAll(".pagination a").forEach(a => {
                a.addEventListener("click", () => {
                    window.scrollTo({ top: 0, behavior: "smooth" });
                });
            });

            /* ============================================
               리뷰 수정 모달
            ============================================ */
            const modal = document.getElementById('editReviewModal');
            const modalClose = document.querySelector('.modal-close');

            // 모달 열기 - 이벤트 위임 방식
            document.querySelector('.mypage-right').addEventListener('click', function(e) {
                // 수정 버튼 클릭 확인
                if (e.target && e.target.classList.contains('btn-edit')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const reviewId = e.target.dataset.reviewId;
                    const rating = e.target.dataset.rating;
                    const content = e.target.dataset.content;
                    
                    // 모달에 데이터 설정
                    document.getElementById('editReviewId').value = reviewId;
                    document.getElementById('editRating').value = rating;
                    document.getElementById('editContent').value = content;
                    
                    // 모달 열기
                    modal.classList.add('active');
                }
            });

            // 모달 닫기 버튼
            if (modalClose) {
                modalClose.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    modal.classList.remove('active');
                });
            }

            // 모달 외부 클릭 시 닫기
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });

            // ESC 키로 모달 닫기
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>

</body>
</html>