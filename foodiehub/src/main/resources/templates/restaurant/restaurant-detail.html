<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${restaurant.name} + ' - 상세 정보'">맛집 상세</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
	<!-- 로그인 상태 전달 (JavaScript에서 사용) -->
	<input type="hidden" name="userLoggedIn" th:value="${user != null}">
	
    <!-- 공통 헤더 -->
    <div th:replace="layout/header :: header"></div>

    <div class="restaurant-detail">
        <!-- 왼쪽: 이미지 + 기본 정보 -->
        <div class="detail-left">
            <img th:src="${restaurant.mainImageUrl}" alt="대표 이미지">
            <div class="basic-info">
                <h2 th:text="${restaurant.name}"></h2>
                <p><strong>카테고리:</strong> <span th:text="${restaurant.category}"></span></p>
                <p><strong>지역:</strong> <span th:text="${restaurant.region}"></span></p>
                <p><strong>주소:</strong> <span th:text="${restaurant.address}"></span></p>
                <div class="stats">
                    평균 별점: <span th:text="${restaurant.avgRating}">0.0</span><br>
                    리뷰 수: <span th:text="${restaurant.reviewCount}">0</span>
                </div>
            </div>

            <div class="restaurant-actions"
                th:if="${user != null and user.role == 'ROLE_OWNER' and user.id == restaurant.ownerId}">
                <a th:href="@{/restaurant/edit/{id}(id=${restaurant.id})}" class="btn btn-create">수정하기</a>
            </div>
        </div>

        <!-- 오른쪽: 탭 구조 -->
        <div class="detail-right">
            <div class="tabs">
                <div class="tab active" data-tab="detail">상세</div>
                <div class="tab" data-tab="menu">메뉴</div>
                <div class="tab" data-tab="reviews">리뷰</div>
                <div class="tab" data-tab="write">리뷰작성</div>
                <div class="tab" data-tab="gallery">리뷰 이미지</div>
                <div class="tab" data-tab="map">지도</div>
            </div>

            <!-- 상세 -->
            <div id="detail" class="tab-content active">
                <div class="detail-box">
                    <h3>가게 설명</h3>
                    <p th:text="${restaurant.description}">식당 설명이 없습니다.</p>
                    <hr>
                    <p><strong>주소:</strong> <span th:text="${restaurant.address}"></span></p>
                    <p><strong>지역:</strong> <span th:text="${restaurant.region}"></span></p>
                    <p><strong>카테고리:</strong> <span th:text="${restaurant.category}"></span></p>
                </div>
            </div>

            <!-- 리뷰 -->
            <div id="reviews" class="tab-content">
            	<!-- 디버깅: 페이지 상단에서 user 값 확인 -->
            	<!-- user 값: ${user} -->
                <div class="review-slider">
				    <button class="prev-review">◀</button>
				
				    <div class="review-content-wrapper">
				        <div th:each="review, stat : ${reviews}" 
				             th:classappend="${stat.index == 0} ? 'active' : ''"
				             class="review-item">
				             
				            <div class="review-header">
				                <strong th:text="${review.userName}"></strong>
				                <span th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
				                <span class="stars">
				                    <span th:each="i : ${#numbers.sequence(1, review.rating)}">★</span>
				                </span>
				            </div>
				
				            <div class="review-body" th:text="${review.content}">내용이 없습니다.</div>
				
				            <div class="review-images" th:if="${!#lists.isEmpty(review.images)}">
				                <img th:each="img : ${review.images}" th:src="${img.fileUrl}" alt="리뷰 이미지">
				            </div>
				
				            <!-- 댓글 영역 -->
				            <div class="review-comments">
				                <div th:each="reply : ${review.replies}" class="comment-item">
				                    <p>
				                        <strong th:text="${reply.userName}"></strong>
				                        <small th:text="${#temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm')}"></small>
				                    </p>
				                    <p th:text="${reply.content}"></p>
				                </div>
				
				                <!-- 댓글 입력 폼 또는 로그인 안내 -->
				                <div th:if="${user != null}" class="comment-form">
				                    <form th:action="@{/review/reply}" method="post">
				                        <input type="hidden" name="parentId" th:value="${review.id}">
				                        <textarea name="content" placeholder="댓글을 입력하세요" required></textarea>
				                        <button type="submit">등록</button>
				                    </form>
				                </div>
				                <div th:if="${user == null}">
				                    <p class="login-alert">댓글을 작성하려면 <a href="/user/login">로그인</a> 해주세요.</p>
				                </div>
				            </div>
                        </div>
                    </div>

                    <button class="next-review">▶</button>
                </div>

                <div th:if="${#lists.isEmpty(reviews)}">
                    <p>등록된 리뷰가 없습니다.</p>
                </div>
            </div>

            <!-- 리뷰 작성 -->
            <div id="write" class="tab-content">
                <div th:if="${user != null}">
                    <form th:action="@{/review/write}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="restaurantId" th:value="${restaurant.id}">
                        <div class="review-form">
                            <label>별점</label>
                            <select name="rating" required>
                                <option value="5">★★★★★</option>
                                <option value="4">★★★★☆</option>
                                <option value="3">★★★☆☆</option>
                                <option value="2">★★☆☆☆</option>
                                <option value="1">★☆☆☆☆</option>
                            </select>

                            <label>리뷰 내용</label>
                            <textarea name="content" rows="5" placeholder="리뷰를 입력하세요" required></textarea>

                            <label>이미지 업로드</label>
                            <input type="file" name="files" multiple accept="image/*">

                            <button type="submit" class="submit-btn">등록하기</button>
                        </div>
                    </form>
                </div>
                <div th:if="${user == null}">
                    <p class="login-alert">리뷰를 작성하려면 <a href="/user/login">로그인</a> 해주세요.</p>
                </div>
            </div>

            <!-- 이미지 -->
            <div id="gallery" class="tab-content">
                <div th:if="${#lists.isEmpty(images)}">
                    <p>등록된 이미지가 없습니다.</p>
                </div>
                <div class="gallery">
                    <img th:each="img : ${images}" th:src="${img.fileUrl}" alt="리뷰 이미지">
                </div>
            </div>

            <!-- 지도 -->
            <div id="map" class="tab-content" th:attr="data-lat=${restaurant.latitude},data-lng=${restaurant.longitude}"></div>

        </div>
    </div>

    <!-- 공통 푸터 -->
    <div th:replace="layout/footer :: footer"></div>

    <!-- 지도 SDK (API 키는 application.properties에서 주입) -->
    <script th:src="'https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoMapApiKey} + '&libraries=services'"></script>

    <script th:src="@{/js/restaurant-detail.js}"></script>
</body>
</html>