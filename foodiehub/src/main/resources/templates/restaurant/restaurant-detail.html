<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${restaurant.name} + ' - 상세 정보'">맛집 상세</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
	<!-- 로그인 상태 전달 (JavaScript에서 사용) -->
	<input type="hidden" name="userLoggedIn" th:value="${user != null}">
	
    <!-- 공통 헤더 -->
    <div th:replace="layout/header :: header"></div>

    <!-- 페이지 헤더 -->
    <div class="page-header">
        <button type="button" class="btn-back-nav" onclick="history.back()">← 뒤로가기</button>
        <h1>식당 상세</h1>
    </div>

    <div class="restaurant-detail">
        <!-- 왼쪽: 이미지 + 기본 정보 -->
        <div class="detail-left">
            <img th:src="${restaurant.mainImageUrl}"
		     alt="대표 이미지"
		     onerror="this.src='/images/default-thumbnail.png'">
            <div class="basic-info">
                <h2 th:text="${restaurant.name}"></h2>
                <p><strong>카테고리:</strong> <span th:text="${restaurant.category}"></span></p>
                <p><strong>지역:</strong> <span th:text="${restaurant.regionLevel1}"></span></p>
                <p><strong>주소:</strong> <span th:text="${restaurant.address}"></span></p>
                <div class="stats">
                    평균 별점: <span th:text="${restaurant.avgRating}">0.0</span><br>
                    리뷰 수: <span th:text="${restaurant.reviewCount}">0</span>
                </div>
            </div>

            <div class="restaurant-actions"
                th:if="${user != null and user.role == 'ROLE_OWNER' and user.id == restaurant.ownerId}">
                <a th:href="@{/restaurant/edit/{id}(id=${restaurant.id})}" class="btn btn-create">수정하기</a>
            </div>
            
	        <a th:href="@{/menu/manage(restaurantId=${restaurant.id})}"
	           class="btn btn-create"
	           style="width:100%; margin-top:10px;">
	           메뉴 관리
	        </a>
 
            <!-- AI 요약 생성 버튼 (ADMIN 또는 OWNER) -->
            <div class="restaurant-actions" style="margin-top: 10px;"
                th:if="${user != null and (user.role == 'ROLE_ADMIN' or (user.role == 'ROLE_OWNER' and user.id == restaurant.ownerId))}">
               <form th:action="@{/restaurant/generate-ai-summary/{id}(id=${restaurant.id})}" method="post" style="margin: 0;"
                      onsubmit="console.log('Form submitting with method:', this.method); alert('Form 제출 중... Method: ' + this.method); return true;">
                    <button type="submit" class="btn btn-create" style="width: 100%;">🤖 AI 리뷰 요약 생성</button>
                </form>
            </div>
        </div>

        <!-- 오른쪽: 탭 구조 -->
        <div class="detail-right">
            <div class="tabs">
                <div class="tab active" data-tab="detail">상세</div>
                <div class="tab" data-tab="menu">메뉴</div>
                <div class="tab" data-tab="reviews">리뷰</div>
                <div class="tab" data-tab="write">리뷰작성</div>
                <div class="tab" data-tab="gallery">리뷰 이미지</div>
                <div class="tab" data-tab="map">지도</div>
            </div>

            <!-- 상세 -->
            <div id="detail" class="tab-content active">
                <div class="detail-box">
                    <h3>가게 설명</h3>
                    <p th:text="${restaurant.description}">식당 설명이 없습니다.</p>
                    <hr>
                    <p><strong>주소:</strong> <span th:text="${restaurant.address}"></span></p>
                    <p><strong>지역:</strong> <span th:text="${restaurant.regionLevel1}"></span></p>
                    <p><strong>카테고리:</strong> <span th:text="${restaurant.category}"></span></p>
                </div>
                
                <!-- AI 리뷰 요약 박스 -->
			    <div class="detail-box ai-summary-box" th:if="${aiSummary != null and aiSummary.summaryText != null}" style="margin-bottom: 20px;">
			        <h3>🤖 AI 리뷰 요약</h3>
			        <div class="ai-summary-content">
			            <p th:text="${aiSummary.summaryText}"></p>
			            <small class="ai-summary-updated">
			                마지막 업데이트: <span th:text="${#temporals.format(aiSummary.updatedAt, 'yyyy-MM-dd HH:mm')}"></span>
			            </small>
			        </div>
			    </div>
            </div>
            
            <div id="menu" class="tab-content">

		    <!-- [1] 메뉴판 이미지 영역] -->
		    <div class="menu-image-slider" th:if="${!#lists.isEmpty(menuImages)}">
		        <div class="menu-image-track">
		            <img th:each="img : ${menuImages}"
		                 th:src="${img.imageUrl}"
		                 class="menu-thumbnail"
		                 onclick="openImageModal(this.src)"
		                 onerror="this.src='/images/default-thumbnail.png'">
		        </div>
		    </div>
		
		    <!-- 메뉴판 이미지 없을 때 기본 이미지 -->
		    <div class="menu-image-slider" th:if="${#lists.isEmpty(menuImages)}">
		        <div class="menu-image-track">
		            <img src="/images/default-menu-thumbnail.png"
		                 class="menu-thumbnail"
		                 onclick="openImageModal('/images/default-menu-thumbnail.png')">
		        </div>
		    </div>
		
		    <hr class="menu-divider">
		
		    <!-- [2] 메뉴 리스트 영역]-->
		    <div class="detail-box">
		        <h3>메뉴</h3>
		
		        <div id="menuList">
		            <div class="menu-item"
		                 th:each="menu, stat : ${menus}"
		                 th:classappend="${stat.index > 2} ? ' hidden-menu'">
		                <p>
		                    <strong th:text="${menu.name}"></strong>
		                    <span style="float:right;"
		                          th:text="${#numbers.formatInteger(menu.price, 0)} + '원'"></span>
		                </p>
		                <p th:text="${menu.description}"></p>
		            </div>
		        </div>
		
		        <!-- 더보기 버튼 -->
		        <button id="menuMoreBtn"
		                class="btn menu-toggle-btn"
		                th:if="${menus.size() > 3}">
		            전체 메뉴 보기 ▼
		        </button>
		    </div>
		
		</div>

            <!-- 리뷰 -->
            <div id="reviews" class="tab-content">
            	<!-- 디버깅: 페이지 상단에서 user 값 확인 -->
            	
                <div th:if="${#lists.isEmpty(reviews)}">
                    <p>등록된 리뷰가 없습니다.</p>
                </div>
            	<!-- user 값: ${user} -->
                <div class="review-slider">
				    <button class="prev-review">◀</button>
				
				    <div class="review-content-wrapper">
				        <div th:each="review, stat : ${reviews}" 
						     th:id="'review-' + ${review.id}"
						     th:classappend="${stat.index == 0} ? 'active' : ''"
						     class="review-item">
				             
				            <div class="review-header">
				                <strong th:text="${review.userName}"></strong>
				                <span th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
				                <span class="stars">
				                    <span th:each="i : ${#numbers.sequence(1, review.rating)}">★</span>
				                </span>
				            </div>
				
				            <div class="review-body" th:text="${review.content}">내용이 없습니다.</div>
				
				            <div class="review-images" th:if="${!#lists.isEmpty(review.images)}">
				                <img th:each="img : ${review.images}" th:src="${img.fileUrl}" alt="리뷰 이미지">
				            </div>
				
				            <!-- 댓글 영역 -->
				            <div class="review-comments">
				                <div th:each="reply : ${review.replies}" class="comment-item">
				                    <p>
				                        <strong th:text="${reply.userName}"></strong>
				                        <small th:text="${#temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm')}"></small>
				                    </p>
				                    <p th:text="${reply.content}"></p>
				                </div>
				
				                <!-- 댓글 입력 폼 또는 로그인 안내 -->
				                <div th:if="${user != null}" class="comment-form">
				                    <form th:action="@{/review/reply}" method="post">
				                        <input type="hidden" name="parentId" th:value="${review.id}">
				                        <textarea name="content" placeholder="댓글을 입력하세요" required></textarea>
				                        <button type="submit">등록</button>
				                    </form>
				                </div>
				                <div th:if="${user == null}">
				                    <p class="login-alert">댓글을 작성하려면 <a href="/user/login">로그인</a> 해주세요.</p>
				                </div>
				            </div>
                        </div>
                    </div>

                    <button class="next-review">▶</button>
                </div>
            </div>

            <!-- 리뷰 작성 -->
            <div id="write" class="tab-content">
                <div th:if="${user != null}">
                    <form th:action="@{/review/write}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="restaurantId" th:value="${restaurant.id}">
                        <div class="review-form">
                            <label>별점</label>
                            <select name="rating" required>
                                <option value="5">★★★★★</option>
                                <option value="4">★★★★☆</option>
                                <option value="3">★★★☆☆</option>
                                <option value="2">★★☆☆☆</option>
                                <option value="1">★☆☆☆☆</option>
                            </select>

                            <label>리뷰 내용</label>
                            <textarea name="content" rows="5" placeholder="리뷰를 입력하세요" required></textarea>

                            <label>이미지 업로드</label>
                            <input type="file" name="files" multiple accept="image/*">

                            <button type="submit" class="submit-btn">등록하기</button>
                        </div>
                    </form>
                </div>
                <div th:if="${user == null}">
                    <p class="login-alert">리뷰를 작성하려면 <a href="/user/login">로그인</a> 해주세요.</p>
                </div>
            </div>

            <!-- 이미지 -->
            <div id="gallery" class="tab-content">
		
		    <!-- 이미지 있을 때 -->
		    <div class="gallery" th:if="${!#lists.isEmpty(images)}">
		        <img th:each="img : ${images}"
		             th:src="${img.fileUrl}"
		             alt="리뷰 이미지"
		             class="review-thumbnail"
		             onclick="openImageModal(this.src)"
		             onerror="this.src='/images/default-thumbnail.png'">
		    </div>
		
		    <!-- 이미지 없을 때 기본 이미지 1장 표시 -->
		    <div class="gallery" th:if="${#lists.isEmpty(images)}">
		        <img src="/images/default-review-thumbnail.png" 
			         onclick="openImageModal('/images/default-review-thumbnail.png')"
			         class="review-thumbnail"
			         alt="기본 이미지">
		    </div>
		
		</div>

            <!-- 지도 -->
            <div id="map" class="tab-content" th:attr="data-lat=${restaurant.latitude},data-lng=${restaurant.longitude}"></div>

        </div>
    </div>

    <!-- 공통 푸터 -->
    <div th:replace="layout/footer :: footer"></div>

    <!-- 지도 SDK (API 키는 application.properties에서 주입) -->
    <script th:src="'https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoMapApiKey} + '&libraries=services'"></script>

    <script th:src="@{/js/restaurant-detail.js}"></script>
</body>
</html>