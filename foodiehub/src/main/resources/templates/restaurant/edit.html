<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>식당 수정 | FoodieHub</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- 헤더 -->
    <div th:replace="layout/header :: header"></div>
    
    <button type="button" class="back-btn" onclick="history.back()">←</button>

    <div class="form-container">
        <h1>식당 정보 수정</h1>

        <form th:action="@{/restaurant/edit/{id}(id=${restaurant.id})}" 
              method="post" 
              enctype="multipart/form-data"
              class="restaurant-form">

            <!-- [1] 식당명 (읽기전용) -->
            <label>식당명</label>
            <input type="text" th:value="${restaurant.name}" name="name" readonly>

            <!-- [2] 주소 검색 -->
            <label>주소 검색</label>
            <div class="search-group">
                <input type="text" id="addressSearch" placeholder="수정할 주소를 입력하세요">
                <button type="button" class="btn" onclick="searchAddress()">검색</button>
            </div>
            <ul id="resultList" class="search-result"></ul>

            <!-- [3] 주소 -->
            <label>주소</label>
            <input type="text" id="address" name="address" th:value="${restaurant.address}" readonly required>

            <!-- [4] 지역 (읽기전용) -->
            <label>지역</label>
            <input type="text" th:value="${restaurant.region}" name="region" readonly>

            <!-- [5] 카테고리 (읽기전용) -->
			<label>카테고리</label>
            <input type="text" th:value="${restaurant.category}" name="category" readonly>

            <!-- [6] 설명 (수정 가능) -->
            <label>설명</label>
            <textarea name="description" rows="4" placeholder="식당 설명을 입력하세요" th:text="${restaurant.description}"></textarea>

            <!-- [7] 대표 이미지 (수정 가능) -->
            <label>대표 이미지</label>
            <input type="file" id="mainImage" name="mainImage" accept="image/*">
            <small>* 새 이미지를 선택하지 않으면 기존 이미지가 유지됩니다.</small>

            <!-- [8] 이미지 미리보기 -->
            <div id="preview-container">
                <img id="preview" th:src="${restaurant.mainImageUrl}" alt="미리보기" style="display:block;">
            </div>

            <!-- [9] 위도 / 경도 (자동 업데이트) -->
            <label>위도</label>
            <input type="text" id="latitude" name="latitude" th:value="${restaurant.latitude}" readonly>

            <label>경도</label>
            <input type="text" id="longitude" name="longitude" th:value="${restaurant.longitude}" readonly>

            <!-- [10] 지도 표시 -->
            <div id="map"></div>

            <!-- [11] 버튼 -->
            <div class="form-actions">
                <button type="submit" class="btn btn-create">수정</button>
                <a th:href="@{/restaurant/detail/{id}(id=${restaurant.id})}" class="btn cancel-btn">취소</a>
            </div>
        </form>
    </div>

    <!-- 푸터 -->
    <div th:replace="layout/footer :: footer"></div>

    <!-- Kakao 지도 SDK -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e761fa7d455c669671e958c746995557&libraries=services"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // 기존 좌표 가져오기
        const initialLat = /*[[${restaurant.latitude}]]*/ 37.5665;
        const initialLng = /*[[${restaurant.longitude}]]*/ 126.9780;
        
        // 지도 초기화
        let map, marker, geocoder;
        window.onload = function () {
            const container = document.getElementById("map");
            const options = {
                center: new kakao.maps.LatLng(initialLat, initialLng),
                level: 3
            };
            map = new kakao.maps.Map(container, options);
            marker = new kakao.maps.Marker({ 
                position: new kakao.maps.LatLng(initialLat, initialLng), 
                map: map 
            });
            geocoder = new kakao.maps.services.Geocoder();
        };

        // 주소로 검색
        function searchAddress() {
            const query = document.getElementById("addressSearch").value.trim();
            if (!query) return alert("주소를 입력하세요.");

            geocoder.addressSearch(query, function(result, status) {
                if (status !== kakao.maps.services.Status.OK) {
                    alert("검색 결과가 없습니다. 정확한 주소를 입력해주세요.");
                    return;
                }

                const resultList = document.getElementById("resultList");
                resultList.innerHTML = "";
                resultList.style.display = "block";

                result.forEach((place) => {
                    const li = document.createElement("li");
                    li.innerHTML = `<b>${place.address_name}</b>`;
                    if (place.road_address) {
                        li.innerHTML += ` <small>(도로명: ${place.road_address.address_name})</small>`;
                    }
                    li.className = "result-item";
                    li.addEventListener("click", () => selectAddress(place));
                    resultList.appendChild(li);
                });
            });
        }

        // 주소 선택 시 자동 입력 + 지도 이동
        function selectAddress(place) {
            const address = place.road_address ? place.road_address.address_name : place.address_name;
            
            document.getElementById("address").value = address;
            document.getElementById("latitude").value = place.y;
            document.getElementById("longitude").value = place.x;

            const pos = new kakao.maps.LatLng(place.y, place.x);
            map.setCenter(pos);
            marker.setPosition(pos);

            document.getElementById("resultList").style.display = "none";
        }

        // 이미지 미리보기
        document.getElementById("mainImage").addEventListener("change", function (e) {
            const file = e.target.files[0];
            const preview = document.getElementById("preview");
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    preview.src = ev.target.result;
                    preview.style.display = "block";
                };
                reader.readAsDataURL(file);
            }
        });
        /*]]>*/
    </script>
</body>
</html>