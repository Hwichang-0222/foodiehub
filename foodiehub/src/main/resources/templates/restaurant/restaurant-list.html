<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>맛집 목록 | FoodieHub</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

    <!-- 공통 헤더 -->
    <div th:replace="layout/header :: header"></div>

    <main class="restaurant-page">

        <!-- 검색창 -->
        <div class="restaurant-search">
            <form th:action="@{/restaurant/list}" method="get">
                <input type="text" name="keyword" placeholder="맛집 이름을 검색하세요" th:value="${keyword}">
                <button type="submit" class="btn">검색</button>
                <a th:href="@{/restaurant/list}" class="reset-btn">초기화</a>
            </form>
        </div>

        
        <!-- 검색 결과 총 개수 -->
        <div class="result-count" th:if="${totalCount > 0}">
            총 <span th:text="${totalCount}">0</span>개의 맛집이 검색되었습니다.
        </div>
        <div class="result-count" th:if="${totalCount == 0}">
            검색 결과가 없습니다.
        </div>
        

        <!-- 메인 컨테이너 -->
        <div class="restaurant-container-row">

            <!-- 필터 영역 -->
            <div class="filter-bar-row">
                
                <!-- 음식 필터 -->
                <div class="filter-box">
                    <div class="filter-header-single">
                        <a th:href="@{/restaurant/list(region=${region}, district=${district}, keyword=${keyword})}">음식</a>
                    </div>
                    <div class="filter-body-single">
                        <a th:href="@{/restaurant/list(category='한식', region=${region}, district=${district}, keyword=${keyword})}" th:classappend="${category} == '한식' ? 'active' : ''">한식</a>
                        <a th:href="@{/restaurant/list(category='중식', region=${region}, district=${district}, keyword=${keyword})}" th:classappend="${category} == '중식' ? 'active' : ''">중식</a>
                        <a th:href="@{/restaurant/list(category='일식', region=${region}, district=${district}, keyword=${keyword})}" th:classappend="${category} == '일식' ? 'active' : ''">일식</a>
                        <a th:href="@{/restaurant/list(category='양식', region=${region}, district=${district}, keyword=${keyword})}" th:classappend="${category} == '양식' ? 'active' : ''">양식</a>
                        <a th:href="@{/restaurant/list(category='분식', region=${region}, district=${district}, keyword=${keyword})}" th:classappend="${category} == '분식' ? 'active' : ''">분식</a>
                        <a th:href="@{/restaurant/list(category='패스트푸드', region=${region}, district=${district}, keyword=${keyword})}" th:classappend="${category} == '패스트푸드' ? 'active' : ''">패스트푸드</a>
                        <a th:href="@{/restaurant/list(category='카페', region=${region}, district=${district}, keyword=${keyword})}" th:classappend="${category} == '카페' ? 'active' : ''">카페</a>
                        <a th:href="@{/restaurant/list(category='디저트', region=${region}, district=${district}, keyword=${keyword})}" th:classappend="${category} == '디저트' ? 'active' : ''">디저트</a>
                        <a th:href="@{/restaurant/list(category='고기', region=${region}, district=${district}, keyword=${keyword})}" th:classappend="${category} == '고기' ? 'active' : ''">고기</a>
                        <a th:href="@{/restaurant/list(category='해산물', region=${region}, district=${district}, keyword=${keyword})}" th:classappend="${category} == '해산물' ? 'active' : ''">해산물</a>
                        <a th:href="@{/restaurant/list(category='술집', region=${region}, district=${district}, keyword=${keyword})}" th:classappend="${category} == '술집' ? 'active' : ''">술집</a>
                        <a th:href="@{/restaurant/list(category='기타', region=${region}, district=${district}, keyword=${keyword})}" th:classappend="${category} == '기타' ? 'active' : ''">기타</a>
                    </div>
                </div>

                
                <!-- 지역 필터 (1단계: 시/도) -->
                <div class="filter-box">
                    <div class="filter-header-single">
                        <a th:href="@{/restaurant/list(category=${category}, keyword=${keyword})}">지역</a>
                    </div>
                    <div class="filter-body-single">
                        <a href="javascript:void(0)" onclick="selectCity('서울')" th:classappend="${region} == '서울' ? 'active' : ''">서울</a>
                        <a href="javascript:void(0)" onclick="selectCity('부산')" th:classappend="${region} == '부산' ? 'active' : ''">부산</a>
                        <a href="javascript:void(0)" onclick="selectCity('대구')" th:classappend="${region} == '대구' ? 'active' : ''">대구</a>
                        <a href="javascript:void(0)" onclick="selectCity('인천')" th:classappend="${region} == '인천' ? 'active' : ''">인천</a>
                        <a href="javascript:void(0)" onclick="selectCity('광주')" th:classappend="${region} == '광주' ? 'active' : ''">광주</a>
                        <a href="javascript:void(0)" onclick="selectCity('대전')" th:classappend="${region} == '대전' ? 'active' : ''">대전</a>
                        <a href="javascript:void(0)" onclick="selectCity('울산')" th:classappend="${region} == '울산' ? 'active' : ''">울산</a>
                        <a href="javascript:void(0)" onclick="selectCity('세종')" th:classappend="${region} == '세종' ? 'active' : ''">세종</a>
                        <a href="javascript:void(0)" onclick="selectCity('경기')" th:classappend="${region} == '경기' ? 'active' : ''">경기</a>
                        <a href="javascript:void(0)" onclick="selectCity('강원')" th:classappend="${region} == '강원' ? 'active' : ''">강원</a>
                        <a href="javascript:void(0)" onclick="selectCity('충북')" th:classappend="${region} == '충북' ? 'active' : ''">충북</a>
                        <a href="javascript:void(0)" onclick="selectCity('충남')" th:classappend="${region} == '충남' ? 'active' : ''">충남</a>
                        <a href="javascript:void(0)" onclick="selectCity('전북')" th:classappend="${region} == '전북' ? 'active' : ''">전북</a>
                        <a href="javascript:void(0)" onclick="selectCity('전남')" th:classappend="${region} == '전남' ? 'active' : ''">전남</a>
                        <a href="javascript:void(0)" onclick="selectCity('경북')" th:classappend="${region} == '경북' ? 'active' : ''">경북</a>
                        <a href="javascript:void(0)" onclick="selectCity('경남')" th:classappend="${region} == '경남' ? 'active' : ''">경남</a>
                        <a href="javascript:void(0)" onclick="selectCity('제주')" th:classappend="${region} == '제주' ? 'active' : ''">제주</a>
                        <a th:href="@{/restaurant/list(region='기타', category=${category}, keyword=${keyword})}" th:classappend="${region} == '기타' ? 'active' : ''">기타</a>
                    </div>
                </div>

                <!-- 지역 필터 (2단계: 구/군) - 동적 생성 -->
                <div class="filter-box" id="district-filter-box" style="display:none;">
                    <div class="filter-header-single">
                        <a href="javascript:void(0)" onclick="clearDistrict()">상세 지역</a>
                    </div>
                    <div class="filter-body-single" id="district-filter-body">
                        <!-- JavaScript로 동적 생성 -->
                    </div>
                </div>
            </div>

            <!-- 오른쪽 리스트 -->
            <section class="restaurant-list">
                <div th:if="${#lists.isEmpty(restaurants)}" class="no-result">
                    <p>검색 결과가 없습니다.</p>
                </div>

                <div class="restaurant-item" th:each="r : ${restaurants}">
                    <a th:href="@{'/restaurant/detail/' + ${r.id}}" class="restaurant-link">
                        <img th:src="${r.mainImageUrl}" alt="thumbnail" onerror="this.src='/images/default-thumbnail.png'">
                        <div class="restaurant-info">
                            <h4 th:text="${r.name}">식당 이름</h4>
                            <p th:text="'★ ' + ${r.avgRating} + ' | ' + ${r.category} + ' | ' + ${r.regionLevel1} + (${r.regionLevel2} != null ? ' ' + ${r.regionLevel2} : '')"></p>
                            <p th:text="${r.address}"></p>
                        </div>
                    </a>
                </div>
                
                <!-- 페이지네이션 -->
                <div class="pagination">
                    <a th:if="${currentPage > 1}" th:href="@{/restaurant/list(region=${region}, district=${district}, category=${category}, keyword=${keyword}, page=${currentPage - 1})}">« 이전</a>
                    <span th:text="${currentPage}"></span>
                    <a th:if="${currentPage < totalPages}" th:href="@{/restaurant/list(region=${region}, district=${district}, category=${category}, keyword=${keyword}, page=${currentPage + 1})}">다음 »</a>
                </div>
                
            </section>
        </div>
    </main>

    <!-- 공통 푸터 -->
    <div th:replace="layout/footer :: footer"></div>

    <!-- 지역 필터 동적 로딩 스크립트 -->
    <script th:inline="javascript">
        /* ===== 지역 필터 동적 로딩 ===== */
        let regionsData = {};
        let currentSelectedCity = /*[[${region}]]*/ null;
        let currentSelectedDistrict = /*[[${district}]]*/ null;
        let currentCategory = /*[[${category}]]*/ null;
        let currentKeyword = /*[[${keyword}]]*/ null;

        // 01. 페이지 로드 시 JSON 데이터 로드
        document.addEventListener('DOMContentLoaded', function() {
            loadRegionsData();
        });

        // 02. JSON 파일에서 지역 데이터 로드
        function loadRegionsData() {
            fetch('/data/regions.json')
                .then(response => response.json())
                .then(data => {
                    regionsData = data;
                    console.log('지역 데이터 로드 완료');
                    
                    // 페이지 로드 시 이미 선택된 시/도가 있으면 구/군 필터 표시
                    if (currentSelectedCity && currentSelectedCity !== '기타') {
                        showDistrictFilter(currentSelectedCity, false);
                    }
                })
                .catch(error => {
                    console.error('지역 데이터 로드 실패:', error);
                });
        }

        // 03. 시/도 선택 처리
        function selectCity(city) {
            currentSelectedCity = city;
            
            // "기타" 선택 시 즉시 페이지 이동
            if (city === '기타') {
                const url = buildURL(currentCategory, city, null, currentKeyword);
                window.location.href = url;
                return;
            }
            
            // 구/군 필터 표시
            showDistrictFilter(city, true);
        }

        // 04. 구/군 필터 동적 생성 및 표시
        function showDistrictFilter(city, navigateOnCityOnly) {
            const filterBox = document.getElementById('district-filter-box');
            const filterBody = document.getElementById('district-filter-body');
            
            // 기존 구/군 옵션 제거
            filterBody.innerHTML = '';
            
            // 해당 시/도의 구/군 목록 가져오기
            const districts = regionsData[city];
            
            if (!districts || districts.length === 0) {
                filterBox.style.display = 'none';
                return;
            }
            
            // "전체" 옵션 추가 (시/도만 선택)
            const allLink = document.createElement('a');
            allLink.href = buildURL(currentCategory, city, null, currentKeyword);
            allLink.textContent = '전체';
            if (!currentSelectedDistrict) {
                allLink.classList.add('active');
            }
            filterBody.appendChild(allLink);
            
            // 구/군 옵션 추가
            districts.forEach(district => {
                const link = document.createElement('a');
                link.href = buildURL(currentCategory, city, district, currentKeyword);
                link.textContent = district;
                
                // 현재 선택된 구/군 활성화
                if (currentSelectedDistrict === district) {
                    link.classList.add('active');
                }
                
                filterBody.appendChild(link);
            });
            
            // 필터박스 표시
            filterBox.style.display = 'block';
            
            // 시/도만 선택한 경우 즉시 페이지 이동 (처음 클릭 시에만)
            if (navigateOnCityOnly) {
                const url = buildURL(currentCategory, city, null, currentKeyword);
                window.location.href = url;
            }
        }

        // 05. 구/군 필터 초기화
        function clearDistrict() {
            const url = buildURL(currentCategory, currentSelectedCity, null, currentKeyword);
            window.location.href = url;
        }

        // 06. URL 생성 헬퍼 함수
        function buildURL(category, region, district, keyword) {
            const params = new URLSearchParams();
            
            if (category) params.append('category', category);
            if (region) params.append('region', region);
            if (district) params.append('district', district);
            if (keyword) params.append('keyword', keyword);
            
            return '/restaurant/list' + (params.toString() ? '?' + params.toString() : '');
        }
    </script>

</body>
</html>