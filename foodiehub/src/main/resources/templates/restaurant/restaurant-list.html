<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>맛집 목록 | FoodieHub</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

    <!-- 공통 헤더 -->
    <div th:replace="~{layout/header :: header}"></div>

    <main class="restaurant-page">

        <!-- 검색창 -->
        <div class="restaurant-search">
            <form th:action="@{/restaurant/list}" method="get">
                <input type="text" name="keyword" placeholder="맛집 이름을 검색하세요" th:value="${keyword}">
                <button type="submit" class="btn">검색</button>
                <a th:href="@{/restaurant/list}" class="reset-btn">초기화</a>
            </form>
        </div>

        
        <!-- 검색 결과 총 개수 -->
        <div class="result-count" th:if="${totalCount > 0}">
            총 <span th:text="${totalCount}">0</span>개의 맛집이 검색되었습니다.
        </div>
        <div class="result-count" th:if="${totalCount == 0}">
            검색 결과가 없습니다.
        </div>
        

        <!-- 메인 컨테이너 -->
        <div class="restaurant-container-row">

            <!-- 필터 영역 -->
            <div class="filter-bar-row">
                
                <!-- 음식 필터 -->
                <div class="filter-box">
                    <div class="filter-header-single">
                        <a th:href="@{/restaurant/list(regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}">음식</a>
                    </div>
                    <div class="filter-body-single">
                        <a th:href="@{/restaurant/list(category='한식', regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}" th:classappend="${category} == '한식' ? 'active' : ''">한식</a>
                        <a th:href="@{/restaurant/list(category='중식', regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}" th:classappend="${category} == '중식' ? 'active' : ''">중식</a>
                        <a th:href="@{/restaurant/list(category='일식', regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}" th:classappend="${category} == '일식' ? 'active' : ''">일식</a>
                        <a th:href="@{/restaurant/list(category='양식', regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}" th:classappend="${category} == '양식' ? 'active' : ''">양식</a>
                        <a th:href="@{/restaurant/list(category='분식', regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}" th:classappend="${category} == '분식' ? 'active' : ''">분식</a>
                        <a th:href="@{/restaurant/list(category='패스트푸드', regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}" th:classappend="${category} == '패스트푸드' ? 'active' : ''">패스트푸드</a>
                        <a th:href="@{/restaurant/list(category='카페', regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}" th:classappend="${category} == '카페' ? 'active' : ''">카페</a>
                        <a th:href="@{/restaurant/list(category='디저트', regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}" th:classappend="${category} == '디저트' ? 'active' : ''">디저트</a>
                        <a th:href="@{/restaurant/list(category='고기', regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}" th:classappend="${category} == '고기' ? 'active' : ''">고기</a>
                        <a th:href="@{/restaurant/list(category='해산물', regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}" th:classappend="${category} == '해산물' ? 'active' : ''">해산물</a>
                        <a th:href="@{/restaurant/list(category='술집', regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}" th:classappend="${category} == '술집' ? 'active' : ''">술집</a>
                        <a th:href="@{/restaurant/list(category='기타', regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, keyword=${keyword})}" th:classappend="${category} == '기타' ? 'active' : ''">기타</a>
                    </div>
                </div>

                
                <!-- 지역 필터 (1단계: 시/도) -->
                <div class="filter-box">
                    <div class="filter-header-single">
                        <a th:href="@{/restaurant/list(category=${category}, keyword=${keyword})}">지역</a>
                    </div>
                    <div class="filter-body-single">
                        <a href="javascript:void(0)" onclick="selectCity('서울')" th:classappend="${regionLevel1} == '서울' ? 'active' : ''">서울</a>
                        <a href="javascript:void(0)" onclick="selectCity('부산')" th:classappend="${regionLevel1} == '부산' ? 'active' : ''">부산</a>
                        <a href="javascript:void(0)" onclick="selectCity('대구')" th:classappend="${regionLevel1} == '대구' ? 'active' : ''">대구</a>
                        <a href="javascript:void(0)" onclick="selectCity('인천')" th:classappend="${regionLevel1} == '인천' ? 'active' : ''">인천</a>
                        <a href="javascript:void(0)" onclick="selectCity('광주')" th:classappend="${regionLevel1} == '광주' ? 'active' : ''">광주</a>
                        <a href="javascript:void(0)" onclick="selectCity('대전')" th:classappend="${regionLevel1} == '대전' ? 'active' : ''">대전</a>
                        <a href="javascript:void(0)" onclick="selectCity('울산')" th:classappend="${regionLevel1} == '울산' ? 'active' : ''">울산</a>
                        <a href="javascript:void(0)" onclick="selectCity('세종')" th:classappend="${regionLevel1} == '세종' ? 'active' : ''">세종</a>
                        <a href="javascript:void(0)" onclick="selectCity('경기')" th:classappend="${regionLevel1} == '경기' ? 'active' : ''">경기</a>
                        <a href="javascript:void(0)" onclick="selectCity('강원')" th:classappend="${regionLevel1} == '강원' ? 'active' : ''">강원</a>
                        <a href="javascript:void(0)" onclick="selectCity('충북')" th:classappend="${regionLevel1} == '충북' ? 'active' : ''">충북</a>
                        <a href="javascript:void(0)" onclick="selectCity('충남')" th:classappend="${regionLevel1} == '충남' ? 'active' : ''">충남</a>
                        <a href="javascript:void(0)" onclick="selectCity('전북')" th:classappend="${regionLevel1} == '전북' ? 'active' : ''">전북</a>
                        <a href="javascript:void(0)" onclick="selectCity('전남')" th:classappend="${regionLevel1} == '전남' ? 'active' : ''">전남</a>
                        <a href="javascript:void(0)" onclick="selectCity('경북')" th:classappend="${regionLevel1} == '경북' ? 'active' : ''">경북</a>
                        <a href="javascript:void(0)" onclick="selectCity('경남')" th:classappend="${regionLevel1} == '경남' ? 'active' : ''">경남</a>
                        <a href="javascript:void(0)" onclick="selectCity('제주')" th:classappend="${regionLevel1} == '제주' ? 'active' : ''">제주</a>
                        <a th:href="@{/restaurant/list(regionLevel1='기타', category=${category}, keyword=${keyword})}" th:classappend="${regionLevel1} == '기타' ? 'active' : ''">기타</a>
                    </div>
                </div>

                <!-- 지역 필터 (2단계: 구/군) -->
                <div class="filter-box" id="district-filter-box" style="display:none;">
                    <div class="filter-header-single">
                        <a href="javascript:void(0)" onclick="clearDistrict()">상세 지역</a>
                    </div>
                    <div class="filter-body-single" id="district-filter-body">
                        <!-- JS로 생성 -->
                    </div>
                </div>
            </div>

            <!-- 오른쪽 리스트 -->
            <section class="restaurant-list">
                <div th:if="${#lists.isEmpty(restaurants)}" class="no-result">
                    <p>검색 결과가 없습니다.</p>
                </div>

                <div class="restaurant-item" th:each="r : ${restaurants}">
                    <a th:href="@{'/restaurant/detail/' + ${r.id}}" class="restaurant-link">
                        <img th:src="${r.mainImageUrl}" alt="thumbnail" onerror="this.src='/images/default-thumbnail.png'">
                        <div class="restaurant-info">
                            <h4 th:text="${r.name}">식당 이름</h4>
                            <p th:text="'★ ' + ${r.avgRating} + ' | ' + ${r.category} + ' | ' + ${r.regionLevel1}"></p>
                            <p th:text="${r.address}"></p>
                        </div>
                    </a>
                </div>
                
                <!-- 페이지네이션 -->
                <div class="pagination">
                    <a th:if="${currentPage > 1}" th:href="@{/restaurant/list(regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, category=${category}, keyword=${keyword}, page=${currentPage - 1})}">« 이전</a>
                    <span th:text="${currentPage}"></span>
                    <a th:if="${currentPage < totalPages}" th:href="@{/restaurant/list(regionLevel1=${regionLevel1}, regionLevel2=${regionLevel2}, category=${category}, keyword=${keyword}, page=${currentPage + 1})}">다음 »</a>
                </div>
                
            </section>
        </div>
    </main>

    <!-- 공통 푸터 -->
    <div th:replace="~{layout/footer :: footer}"></div>

    <!-- 지역 필터 동적 로딩 스크립트 -->
    <script th:inline="javascript">

        /* ===== 지역 필터 동적 로딩 ===== */

        let regionsData = {
            "서울": ["강남구","강동구","강북구","강서구","관악구","광진구","구로구","금천구","노원구","도봉구","동대문구","동작구","마포구","서대문구","서초구","성동구","성북구","송파구","양천구","영등포구","용산구","은평구","종로구","중구","중랑구"],
            "부산": ["해운대구","수영구","남구","연제구","동래구","부산진구","중구","서구","영도구","동구","북구","강서구","사하구","금정구","사상구"],
            "대구": ["중구","동구","서구","남구","북구","수성구","달서구","달성군"],
            "인천": ["중구","동구","미추홀구","연수구","남동구","부평구","계양구","서구","강화군","옹진군"],
            "광주": ["동구","서구","남구","북구","광산구"],
            "대전": ["동구","중구","서구","유성구","대덕구"],
            "울산": ["중구","남구","동구","북구","울주군"],
            "세종": ["세종시"],
            "경기": ["수원시","용인시","성남시","고양시","부천시","안양시","안산시","남양주시","화성시","평택시","의정부시","파주시","김포시","광주시","하남시","군포시","오산시","이천시","안성시","의왕시","양평군","여주시","가평군"],
            "강원": ["춘천시","원주시","강릉시","동해시","삼척시","속초시","홍천군","평창군","정선군","영월군","횡성군","인제군","양양군","고성군","태백시"],
            "충북": ["청주시","충주시","제천시","보은군","옥천군","영동군","진천군","괴산군","음성군","단양군"],
            "충남": ["천안시","공주시","보령시","아산시","서산시","논산시","계룡시","당진시","금산군","부여군","서천군","홍성군","예산군","청양군","태안군"],
            "전북": ["전주시","익산시","군산시","정읍시","김제시","남원시","완주군","고창군","부안군"],
            "전남": ["목포시","여수시","순천시","나주시","광양시","담양군","곡성군","구례군","고흥군","보성군","화순군","장흥군","강진군","해남군","영암군","무안군","함평군","영광군","장성군","완도군","진도군","신안군"],
            "경북": ["포항시","경주시","김천시","안동시","구미시","영주시","영천시","상주시","문경시","경산시","의성군","청송군","영양군","영덕군","청도군","고령군","성주군","칠곡군","예천군","봉화군","울진군","울릉군"],
            "경남": ["창원시","진주시","통영시","사천시","김해시","밀양시","거제시","양산시","의령군","함안군","창녕군","고성군","남해군","함양군","거창군","합천군"],
            "제주": ["제주시","서귀포시"]
        };

        let currentSelectedCity = /*[[${regionLevel1}]]*/ null;
        let currentSelectedDistrict = /*[[${regionLevel2}]]*/ null;
        let currentCategory = /*[[${category}]]*/ null;
        let currentKeyword = /*[[${keyword}]]*/ null;

        if (currentSelectedCity === '') currentSelectedCity = null;
        if (currentSelectedDistrict === '') currentSelectedDistrict = null;
        if (currentCategory === '') currentCategory = null;
        if (currentKeyword === '') currentKeyword = null;

        document.addEventListener('DOMContentLoaded', function() {
            if (currentSelectedCity && currentSelectedCity !== '기타') {
                showDistrictFilter(currentSelectedCity, false);
            }
        });

        function selectCity(city) {
            currentSelectedCity = city;

            if (city === '기타') {
                window.location.href = buildURL(currentCategory, city, null, currentKeyword);
                return;
            }

            showDistrictFilter(city, true);
        }

        function showDistrictFilter(city, move) {
            const box = document.getElementById('district-filter-box');
            const body = document.getElementById('district-filter-body');

            body.innerHTML = '';
            let districts = regionsData[city];

            if (!districts) {
                box.style.display = 'none';
                return;
            }

            const all = document.createElement('a');
            all.href = buildURL(currentCategory, city, null, currentKeyword);
            all.textContent = '전체';
            if (!currentSelectedDistrict) all.classList.add('active');
            body.appendChild(all);

            districts.forEach(d => {
                const link = document.createElement('a');
                link.href = buildURL(currentCategory, city, d, currentKeyword);
                link.textContent = d;

                if (currentSelectedDistrict === d) link.classList.add('active');

                body.appendChild(link);
            });

            box.style.display = 'block';

            if (move) {
                window.location.href = buildURL(currentCategory, city, null, currentKeyword);
            }
        }

        function clearDistrict() {
            window.location.href = buildURL(currentCategory, currentSelectedCity, null, currentKeyword);
        }

        function buildURL(category, regionLevel1, regionLevel2, keyword) {
            const params = new URLSearchParams();

            if (category) params.append('category', category);
            if (regionLevel1) params.append('regionLevel1', regionLevel1);
            if (regionLevel2) params.append('regionLevel2', regionLevel2);
            if (keyword) params.append('keyword', keyword);

            return '/restaurant/list' + (params.toString() ? '?' + params.toString() : '');
        }
    </script>

</body>
</html>
