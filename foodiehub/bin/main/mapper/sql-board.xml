<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.embed.mapper.BoardMapper">

    <!-- ======================================
         공지글 조회
    ====================================== -->
    
    <!-- 탭별 공지글 (전역공지 + 탭별 공지) -->
    <select id="findNoticesByCategory" resultType="org.embed.dto.BoardDTO">
        <![CDATA[
            SELECT b.*, u.name AS user_name
            FROM board b
            INNER JOIN user u ON b.user_id = u.id
            WHERE b.parent_id IS NULL
              AND (
                    (#{category} = 'NOTICE' AND b.category = 'NOTICE')
                 OR (#{category} = 'GENERAL' AND b.category IN ('NOTICE','NOTICE_GENERAL'))
                 OR (#{category} = 'QUESTION' AND b.category IN ('NOTICE','NOTICE_QUESTION'))
                 OR (#{category} = 'SUGGESTION' AND b.category IN ('NOTICE','NOTICE_SUGGESTION'))
              )
            ORDER BY 
                CASE 
                    WHEN b.category = 'NOTICE' THEN 0
                    WHEN b.category LIKE 'NOTICE_%' THEN 1
                    ELSE 2
                END,
                b.created_at DESC
        ]]>
    </select>

    <!-- ======================================
         일반글 조회
    ====================================== -->
    
    <!-- 탭별 일반글 (페이지네이션) -->
    <select id="findNormalPostsByCategory" resultType="org.embed.dto.BoardDTO">
        <![CDATA[
            SELECT b.*, u.name AS user_name
            FROM board b
            INNER JOIN user u ON b.user_id = u.id
            WHERE b.parent_id IS NULL
              AND (
                    (#{category} = 'GENERAL' AND b.category = 'GENERAL')
                 OR (#{category} = 'QUESTION' AND b.category = 'QUESTION')
                 OR (#{category} = 'SUGGESTION' AND b.category = 'SUGGESTION')
              )
            ORDER BY b.created_at DESC
            LIMIT #{offset}, #{limit}
        ]]>
    </select>

    <!-- 일반글 총 개수 -->
    <select id="countNormalPostsByCategory" resultType="int">
        <![CDATA[
            SELECT COUNT(*)
            FROM board b
            WHERE b.parent_id IS NULL
              AND (
                    (#{category} = 'GENERAL' AND b.category = 'GENERAL')
                 OR (#{category} = 'QUESTION' AND b.category = 'QUESTION')
                 OR (#{category} = 'SUGGESTION' AND b.category = 'SUGGESTION')
              )
        ]]>
    </select>

    <!-- ======================================
         검색
    ====================================== -->
    
    <!-- 게시글 검색 (탭별 카테고리 + 키워드) -->
    <select id="searchBoard" resultType="org.embed.dto.BoardDTO">
        <![CDATA[
            SELECT b.*, u.name AS user_name
            FROM board b
            INNER JOIN user u ON b.user_id = u.id
            WHERE b.parent_id IS NULL
              AND (
                    (#{category} = 'GENERAL' AND b.category IN ('NOTICE','NOTICE_GENERAL','GENERAL'))
                 OR (#{category} = 'QUESTION' AND b.category IN ('NOTICE','NOTICE_QUESTION','QUESTION'))
                 OR (#{category} = 'SUGGESTION' AND b.category IN ('NOTICE','NOTICE_SUGGESTION','SUGGESTION'))
                 OR (#{category} = 'NOTICE' AND b.category = 'NOTICE')
              )
              AND (
                    b.title LIKE CONCAT('%', #{keyword}, '%')
                    OR b.content LIKE CONCAT('%', #{keyword}, '%')
                    OR u.name LIKE CONCAT('%', #{keyword}, '%')
              )
            ORDER BY 
                CASE 
                    WHEN b.category = 'NOTICE' THEN 0
                    WHEN b.category LIKE 'NOTICE_%' THEN 1
                    ELSE 2
                END,
                b.created_at DESC
            LIMIT #{offset}, #{limit}
        ]]>
    </select>

    <!-- 검색 결과 개수 -->
    <select id="countSearchBoards" resultType="int">
        <![CDATA[
            SELECT COUNT(*)
            FROM board b
            INNER JOIN user u ON b.user_id = u.id
            WHERE b.parent_id IS NULL
              AND (
                    (#{category} = 'GENERAL' AND b.category IN ('NOTICE','NOTICE_GENERAL','GENERAL'))
                 OR (#{category} = 'QUESTION' AND b.category IN ('NOTICE','NOTICE_QUESTION','QUESTION'))
                 OR (#{category} = 'SUGGESTION' AND b.category IN ('NOTICE','NOTICE_SUGGESTION','SUGGESTION'))
                 OR (#{category} = 'NOTICE' AND b.category = 'NOTICE')
              )
              AND (
                    b.title LIKE CONCAT('%', #{keyword}, '%')
                    OR b.content LIKE CONCAT('%', #{keyword}, '%')
                    OR u.name LIKE CONCAT('%', #{keyword}, '%')
              )
        ]]>
    </select>

    <!-- ======================================
         기본 CRUD
    ====================================== -->
    
    <!-- 단일 게시글 조회 -->
    <select id="findById" parameterType="long" resultType="org.embed.dto.BoardDTO">
        <![CDATA[
            SELECT b.*, u.name AS user_name
            FROM board b
            INNER JOIN user u ON b.user_id = u.id
            WHERE b.id = #{id}
        ]]>
    </select>

    <!-- 게시글 등록 -->
    <insert id="insertBoard" parameterType="org.embed.dto.BoardDTO" useGeneratedKeys="true" keyProperty="id">
        <![CDATA[
            INSERT INTO board (
                user_id, 
                title, 
                content, 
                category, 
                is_private,
                created_at
            ) VALUES (
                #{userId}, 
                #{title}, 
                #{content}, 
                #{category}, 
                #{isPrivate},
                NOW()
            )
        ]]>
    </insert>

    <!-- 게시글 수정 -->
    <update id="updateBoard" parameterType="org.embed.dto.BoardDTO">
        <![CDATA[
            UPDATE board
            SET 
                title = #{title},
                content = #{content},
                category = #{category},
                updated_at = CURRENT_TIMESTAMP
            WHERE id = #{id}
              AND user_id = #{userId}
        ]]>
    </update>

    <!-- 게시글 삭제 -->
    <delete id="deleteBoard" parameterType="long">
        <![CDATA[
            DELETE FROM board
            WHERE id = #{id}
        ]]>
    </delete>

    <!-- 조회수 증가 -->
    <update id="increaseViewCount" parameterType="long">
        <![CDATA[
            UPDATE board
            SET view_count = view_count + 1
            WHERE id = #{id}
        ]]>
    </update>

    <!-- ======================================
         관리자 답변
    ====================================== -->
    
    <!-- 관리자 답변 등록 -->
    <insert id="insertAdminReply" parameterType="org.embed.dto.BoardDTO">
        <![CDATA[
            INSERT INTO board (
                user_id, 
                parent_id, 
                title, 
                content, 
                category
            ) VALUES (
                #{userId}, 
                #{parentId}, 
                '관리자 답변', 
                #{content}, 
                'NOTICE_GENERAL'
            )
        ]]>
    </insert>

    <!-- ======================================
         사용자별 조회 (마이페이지)
    ====================================== -->
    
    <!-- 사용자 작성글 목록 -->
    <select id="findByUserId" parameterType="long" resultType="org.embed.dto.BoardDTO">
        <![CDATA[
            SELECT b.*, u.name AS user_name
            FROM board b
            INNER JOIN user u ON b.user_id = u.id
            WHERE b.user_id = #{userId}
            ORDER BY b.created_at DESC
        ]]>
    </select>

    <!-- 사용자별 게시글 총 개수 -->
    <select id="countByUserId" parameterType="long" resultType="int">
        <![CDATA[
            SELECT COUNT(*)
            FROM board
            WHERE user_id = #{userId}
              AND parent_id IS NULL
        ]]>
    </select>

    <!-- 사용자별 게시글 목록 (페이지네이션) -->
    <select id="findPagedByUserId" resultType="org.embed.dto.BoardDTO">
        <![CDATA[
            SELECT b.*, u.name AS user_name
            FROM board b
            INNER JOIN user u ON b.user_id = u.id
            WHERE b.user_id = #{userId}
              AND b.parent_id IS NULL
            ORDER BY b.created_at DESC
            LIMIT #{offset}, #{limit}
        ]]>
    </select>

    <!-- ======================================
         관리자 기능
    ====================================== -->
    
    <!-- 공지사항 목록 -->
    <select id="findAllNotices" resultType="org.embed.dto.BoardDTO">
        <![CDATA[
            SELECT b.*, u.name AS user_name
            FROM board b
            INNER JOIN user u ON b.user_id = u.id
            WHERE b.category = 'NOTICE'
            ORDER BY b.created_at DESC
            LIMIT #{offset}, #{limit}
        ]]>
    </select>

    <!-- 공지사항 총 개수 -->
    <select id="countAllNotices" resultType="int">
        <![CDATA[
            SELECT COUNT(*) 
            FROM board 
            WHERE category = 'NOTICE'
        ]]>
    </select>

    <!-- 답글 미등록 요청 게시글 조회 -->
    <select id="findUnansweredRequests" resultType="org.embed.dto.BoardDTO">
        <![CDATA[
            SELECT b.*, u.name AS user_name
            FROM board b
            INNER JOIN user u ON b.user_id = u.id
            WHERE b.parent_id IS NULL
              AND (
                    #{filter} IS NULL
                    OR #{filter} = ''
                    OR b.category = #{filter}
                  )
              AND b.category IN ('QUESTION', 'SUGGESTION')
              AND b.id NOT IN (
                  SELECT parent_id FROM board WHERE parent_id IS NOT NULL
              )
            ORDER BY b.created_at DESC
            LIMIT #{offset}, #{limit}
        ]]>
    </select>

    <!-- 답글 미등록 요청 게시글 총 개수 -->
    <select id="countUnansweredRequests" resultType="int">
        <![CDATA[
            SELECT COUNT(*)
            FROM board b
            WHERE b.parent_id IS NULL
              AND (
                    #{filter} IS NULL
                    OR #{filter} = ''
                    OR b.category = #{filter}
                  )
              AND b.category IN ('QUESTION', 'SUGGESTION')
              AND b.id NOT IN (
                  SELECT parent_id FROM board WHERE parent_id IS NOT NULL
              )
        ]]>
    </select>

</mapper>